#!/usr/local/bin/bash

if [[ -z "$@" || ! -d ~/tmp/collection ]]; then
  echo "USAGE: mia <terms>"
  echo "  terms can be object ids or other things."
  echo "  if other, you need an internet connection to run a search against our collections server."
  echo
  exit 1
fi

for term in "$@"; do
  if egrep '^[0-9]+$' <<<$term > /dev/null && [[ -f ~/tmp/collection/objects/$((term/1000))/$term.json ]]; then
    # $term is an existing object's id
    ids=$term
  else
    # ask sphinx
    result=$(curl --silent "https://collections.artsmia.org/search_controller.php" -d 'page=search' --data-urlencode "query=$term");
    if egrep -q "no result" <<<$result; then
      >&2 echo $term -- no match;
      continue
    else
      ids=$(jq -r '"skipped. why?", (.message | .[])' <<<$result | while read line; do cut -d'_' -f1; done)
    fi
  fi

  for id in $ids; do
    >&2 echo $id
    jq '.' < ~/tmp/collection/objects/$((id/1000))/$id.json
  done
  >&2 echo
done
